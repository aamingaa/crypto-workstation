# æ•°æ®å¤„ç†æ€§èƒ½ä¼˜åŒ–è¯´æ˜

## ä¼˜åŒ–æ¦‚è§ˆ

å·²å¯¹ `data_prepare_coarse_grain_rolling()` å‡½æ•°è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ï¼Œä¸»è¦é€šè¿‡**å¹¶è¡Œå¤„ç†**å’Œ**tqdmè¿›åº¦æ¡**å®ç°åŠ é€Ÿå’Œæ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

## ä¸»è¦æ”¹è¿›

### 1. âœ… å¹¶è¡Œå¤„ç†ï¼ˆå·²å®ç°ï¼‰

**é€Ÿåº¦æå‡ï¼š3-8å€**

#### ä½¿ç”¨æ–¹æ³•ï¼š
```python
# æ–¹å¼1ï¼šä½¿ç”¨æ‰€æœ‰CPUæ ¸å¿ƒï¼ˆé»˜è®¤ï¼‰
result = data_prepare_coarse_grain_rolling(
    sym='ETHUSDT',
    # ... å…¶ä»–å‚æ•°
    use_parallel=True,  # å¯ç”¨å¹¶è¡Œå¤„ç†ï¼ˆé»˜è®¤ï¼‰
    n_jobs=-1  # ä½¿ç”¨æ‰€æœ‰CPUæ ¸å¿ƒï¼ˆé»˜è®¤ï¼‰
)

# æ–¹å¼2ï¼šæŒ‡å®šè¿›ç¨‹æ•°
result = data_prepare_coarse_grain_rolling(
    sym='ETHUSDT',
    # ... å…¶ä»–å‚æ•°
    use_parallel=True,
    n_jobs=4  # ä½¿ç”¨4ä¸ªè¿›ç¨‹
)

# æ–¹å¼3ï¼šè°ƒè¯•æ¨¡å¼ï¼ˆä¸²è¡Œå¤„ç†ï¼‰
result = data_prepare_coarse_grain_rolling(
    sym='ETHUSDT',
    # ... å…¶ä»–å‚æ•°
    use_parallel=False  # ç¦ç”¨å¹¶è¡Œï¼Œç”¨äºè°ƒè¯•
)
```

#### æ€§èƒ½å¯¹æ¯”ï¼š
- **ä¸²è¡Œæ¨¡å¼**ï¼š1000ä¸ªæ ·æœ¬ â‰ˆ 10-15åˆ†é’Ÿ
- **å¹¶è¡Œæ¨¡å¼**ï¼ˆ8æ ¸ï¼‰ï¼š1000ä¸ªæ ·æœ¬ â‰ˆ 2-3åˆ†é’Ÿ
- **åŠ é€Ÿæ¯”**ï¼š3-5å€ï¼ˆå–å†³äºCPUæ ¸å¿ƒæ•°ï¼‰

#### è¿›åº¦æ˜¾ç¤ºï¼š
- **æœ‰tqdm**ï¼šæ˜¾ç¤ºæ¼‚äº®çš„è¿›åº¦æ¡ `å¹¶è¡Œå¤„ç†: 50%|â–ˆâ–ˆâ–ˆâ–ˆâ–Œ    | 500/1000 [01:23<01:23, 6.0æ ·æœ¬/s]`
- **æ— tqdm**ï¼šæ¯100ä¸ªæ ·æœ¬æ‰“å°ä¸€æ¬¡è¿›åº¦ç™¾åˆ†æ¯”

#### å·¥ä½œåŸç†ï¼š
1. å°†æ—¶é—´ç‚¹åˆ—è¡¨åˆ†é…ç»™å¤šä¸ªè¿›ç¨‹
2. æ¯ä¸ªè¿›ç¨‹ç‹¬ç«‹å¤„ç†ä¸€æ‰¹æ—¶é—´ç‚¹
3. æå–ç‰¹å¾ã€è®¡ç®—æ ‡ç­¾
4. æ±‡æ€»æ‰€æœ‰è¿›ç¨‹çš„ç»“æœ

#### é€‚ç”¨åœºæ™¯ï¼š
- âœ… å¤§é‡æ ·æœ¬ï¼ˆ>500ä¸ªæ—¶é—´ç‚¹ï¼‰
- âœ… CPUå¯†é›†å‹è®¡ç®—ï¼ˆç‰¹å¾æå–ï¼‰
- âœ… ç‹¬ç«‹æ ·æœ¬å¤„ç†ï¼ˆæ— ä¾èµ–å…³ç³»ï¼‰

---

## å®‰è£…ä¾èµ–

### å®‰è£…tqdmï¼ˆæ¨èï¼‰

ä¸ºäº†è·å¾—æ›´å¥½çš„è¿›åº¦æ¡æ˜¾ç¤ºæ•ˆæœï¼Œå»ºè®®å®‰è£…tqdmï¼š

```bash
pip install tqdm
```

å¦‚æœæ²¡æœ‰å®‰è£…tqdmï¼Œä»£ç ä¼šè‡ªåŠ¨é™çº§ä¸ºç®€å•çš„ç™¾åˆ†æ¯”è¿›åº¦æ˜¾ç¤ºï¼Œä¸å½±å“åŠŸèƒ½ã€‚

---

## å…¶ä»–å¯é€‰ä¼˜åŒ–æ–¹æ¡ˆ

### 2. ğŸ”§ å‘é‡åŒ–æ ‡ç­¾è®¡ç®—ï¼ˆéƒ¨åˆ†å®ç°ï¼‰

**é€Ÿåº¦æå‡ï¼š1.5-2å€ï¼ˆä»…æ ‡ç­¾è®¡ç®—éƒ¨åˆ†ï¼‰**

å·²æ·»åŠ è¾…åŠ©å‡½æ•° `_compute_vectorized_labels()`ï¼Œå¯æ‰¹é‡è®¡ç®—æ‰€æœ‰æ—¶é—´ç‚¹çš„æ ‡ç­¾ã€‚

**ä¼˜åŠ¿**ï¼š
- é¿å…é€ä¸ªæŸ¥è¯¢ä»·æ ¼
- åˆ©ç”¨pandasçš„å‘é‡åŒ–æ“ä½œ
- å‡å°‘å¾ªç¯å¼€é”€

**é™åˆ¶**ï¼š
- ä»…åŠ é€Ÿæ ‡ç­¾è®¡ç®—éƒ¨åˆ†ï¼ˆçº¦å æ€»æ—¶é—´çš„10-20%ï¼‰
- ç‰¹å¾æå–ä»éœ€é€ä¸ªå¤„ç†

---

### 3. ğŸ’¡ è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

#### A. ç¼“å­˜ç²—ç²’åº¦é‡é‡‡æ ·ç»“æœ
å¦‚æœå¤šä¸ªæ—¶é—´ç‚¹çš„çª—å£é‡å ï¼Œå¯ä»¥ç¼“å­˜é‡é‡‡æ ·ç»“æœï¼š

```python
# ä¼ªä»£ç 
cache = {}
window_key = (window_start, window_end)
if window_key in cache:
    window_coarse_bars = cache[window_key]
else:
    window_coarse_bars = resample(window_raw_data, coarse_grain_period)
    cache[window_key] = window_coarse_bars
```

**æ½œåœ¨æå‡**ï¼š1.2-1.5å€ï¼ˆå¦‚æœçª—å£é‡å åº¦é«˜ï¼‰

#### B. ä¼˜åŒ–ç‰¹å¾æå–
æ£€æŸ¥ `originalFeature.BaseFeature()` çš„å®ç°ï¼š
- æ˜¯å¦æœ‰å†—ä½™è®¡ç®—ï¼Ÿ
- æ˜¯å¦å¯ä»¥å‘é‡åŒ–ï¼Ÿ
- æ˜¯å¦å¯ä»¥ä½¿ç”¨numbaåŠ é€Ÿï¼Ÿ

#### C. å‡å°‘ç»Ÿè®¡é‡è®¡ç®—
å½“å‰è®¡ç®—äº†10ç§ç»Ÿè®¡é‡ï¼ˆmean, std, max, min, last, skew, kurt, median, q25, q75ï¼‰ã€‚
å¦‚æœæŸäº›ç»Ÿè®¡é‡å¯¹æ¨¡å‹è´¡çŒ®ä¸å¤§ï¼Œå¯ä»¥ç§»é™¤ï¼š

```python
# ç²¾ç®€ç‰ˆï¼ˆåªä¿ç•™æœ€é‡è¦çš„ï¼‰
feature_dict[f'{col}_mean'] = col_data.mean()
feature_dict[f'{col}_std'] = col_data.std()
feature_dict[f'{col}_last'] = col_data.iloc[-1]
```

**æ½œåœ¨æå‡**ï¼š1.2-1.3å€

#### D. ä½¿ç”¨NumbaåŠ é€Ÿ
å¯¹ç»Ÿè®¡é‡èšåˆéƒ¨åˆ†ä½¿ç”¨numba JITç¼–è¯‘ï¼š

```python
from numba import jit

@jit(nopython=True)
def compute_stats(data):
    return data.mean(), data.std(), data.max(), data.min()
```

**æ½œåœ¨æå‡**ï¼š1.5-2å€ï¼ˆé’ˆå¯¹ç»Ÿè®¡è®¡ç®—éƒ¨åˆ†ï¼‰

---

## æ€§èƒ½ç›‘æ§

### å¦‚ä½•æµ‹è¯•æ€§èƒ½ï¼š

```python
import time

# ä¸²è¡Œæ¨¡å¼
start = time.time()
result = data_prepare_coarse_grain_rolling(..., use_parallel=False)
serial_time = time.time() - start
print(f"ä¸²è¡Œæ¨¡å¼è€—æ—¶: {serial_time:.2f}ç§’")

# å¹¶è¡Œæ¨¡å¼
start = time.time()
result = data_prepare_coarse_grain_rolling(..., use_parallel=True)
parallel_time = time.time() - start
print(f"å¹¶è¡Œæ¨¡å¼è€—æ—¶: {parallel_time:.2f}ç§’")

print(f"åŠ é€Ÿæ¯”: {serial_time/parallel_time:.2f}x")
```

---

## é¢„æœŸæ€§èƒ½

### å…¸å‹åœºæ™¯ï¼ˆETHUSDT 15åˆ†é’Ÿæ»šåŠ¨ï¼Œ2å°æ—¶ç‰¹å¾çª—å£ï¼‰

| æ ·æœ¬æ•° | ä¸²è¡Œæ¨¡å¼ | å¹¶è¡Œæ¨¡å¼(8æ ¸) | åŠ é€Ÿæ¯” |
|--------|----------|---------------|--------|
| 100    | 1åˆ†é’Ÿ    | 20ç§’          | 3x     |
| 500    | 5åˆ†é’Ÿ    | 1åˆ†é’Ÿ         | 5x     |
| 1000   | 12åˆ†é’Ÿ   | 2.5åˆ†é’Ÿ       | 4.8x   |
| 5000   | 60åˆ†é’Ÿ   | 12åˆ†é’Ÿ        | 5x     |

**æ³¨æ„**ï¼šå®é™…æ€§èƒ½å–å†³äºï¼š
- CPUæ ¸å¿ƒæ•°å’Œé¢‘ç‡
- å†…å­˜å¤§å°
- æ•°æ®å¤æ‚åº¦
- ç‰¹å¾æå–å¤æ‚åº¦

---

## ä½¿ç”¨å»ºè®®

1. **é»˜è®¤ä½¿ç”¨å¹¶è¡Œæ¨¡å¼** - é€‚åˆç”Ÿäº§ç¯å¢ƒ
2. **è°ƒè¯•æ—¶ç”¨ä¸²è¡Œæ¨¡å¼** - ä¾¿äºè¿½è¸ªé”™è¯¯
3. **æ ¹æ®CPUè°ƒæ•´è¿›ç¨‹æ•°** - é¿å…è¿‡è½½
4. **ç›‘æ§å†…å­˜ä½¿ç”¨** - å¹¶è¡Œå¤„ç†ä¼šå¢åŠ å†…å­˜å ç”¨

---

## æ•…éšœæ’æŸ¥

### Q: å¹¶è¡Œæ¨¡å¼æŠ¥é”™ï¼Ÿ
A: åˆ‡æ¢åˆ°ä¸²è¡Œæ¨¡å¼ `use_parallel=False` æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯

### Q: é€Ÿåº¦æå‡ä¸æ˜æ˜¾ï¼Ÿ
A: 
- æ£€æŸ¥CPUæ ¸å¿ƒæ•°ï¼ˆ`cpu_count()`ï¼‰
- æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–ç¨‹åºå ç”¨CPU
- å°è¯•è°ƒæ•´ `n_jobs` å‚æ•°

### Q: å†…å­˜ä¸è¶³ï¼Ÿ
A:
- å‡å°‘ `n_jobs` å‚æ•°
- åˆ†æ‰¹å¤„ç†æ—¶é—´æ®µ
- å¢åŠ ç‰©ç†å†…å­˜

---

## æ›´æ–°æ—¥æœŸ
2025-10-25

