# ä¸ºä»€ä¹ˆ Triple Barrier éœ€è¦è®¡ç®—ç›®æ ‡æ³¢åŠ¨ç‡ï¼Ÿ

## ğŸ“š æ ¸å¿ƒæ¦‚å¿µ

åœ¨ Triple Barrier æ–¹æ³•ä¸­ï¼Œ**ç›®æ ‡æ³¢åŠ¨ç‡ï¼ˆtarget volatilityï¼‰** ç”¨äº**åŠ¨æ€è°ƒæ•´æ­¢ç›ˆæ­¢æŸçš„é˜ˆå€¼**ã€‚

---

## ğŸ¯ é—®é¢˜ï¼šå›ºå®šé˜ˆå€¼çš„ç¼ºé™·

### åœºæ™¯å¯¹æ¯”

å‡è®¾æˆ‘ä»¬äº¤æ˜“åŠ å¯†è´§å¸ï¼Œè®¾ç½®å›ºå®šçš„æ­¢ç›ˆæ­¢æŸï¼š

```python
# å›ºå®šé˜ˆå€¼ï¼ˆé”™è¯¯åšæ³•ï¼‰
æ­¢ç›ˆ = 2%
æ­¢æŸ = 2%
```

| å¸‚åœºçŠ¶æ€ | æ—¥æ³¢åŠ¨ç‡ | é—®é¢˜ |
|---------|---------|------|
| **å¹³é™æœŸ** | 0.5% | 2%é˜ˆå€¼å¤ªå¤§ï¼Œå‡ ä¹æ°¸è¿œä¸ä¼šè§¦å‘ï¼Œåªèƒ½ç­‰åˆ°æ—¶é—´é™åˆ¶é€€å‡º |
| **æ­£å¸¸æœŸ** | 2% | 2%é˜ˆå€¼åˆé€‚ï¼Œèƒ½æ­£å¸¸å·¥ä½œ |
| **æš´æ¶¨æœŸ** | 8% | 2%é˜ˆå€¼å¤ªå°ï¼Œä¼šé¢‘ç¹è§¦å‘ï¼Œé”™è¿‡å¤§æ³¢æ®µè¡Œæƒ… |

### é—®é¢˜æ€»ç»“

- âŒ å›ºå®šé˜ˆå€¼**æ— æ³•é€‚åº”å¸‚åœºçš„æ³¢åŠ¨æ€§å˜åŒ–**
- âŒ åœ¨ä½æ³¢åŠ¨æœŸè§¦å‘å¤ªæ…¢ï¼Œåœ¨é«˜æ³¢åŠ¨æœŸè§¦å‘å¤ªå¿«
- âŒ ä¸åŒèµ„äº§ã€ä¸åŒæ—¶æœŸéœ€è¦äººå·¥è°ƒæ•´å‚æ•°

---

## âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ç›®æ ‡æ³¢åŠ¨ç‡

### åŸç†

```python
# åŠ¨æ€é˜ˆå€¼ï¼ˆæ­£ç¡®åšæ³•ï¼‰
æ­¢ç›ˆé˜ˆå€¼ = å€æ•° Ã— å½“å‰æ³¢åŠ¨ç‡
æ­¢æŸé˜ˆå€¼ = å€æ•° Ã— å½“å‰æ³¢åŠ¨ç‡
```

### ä»£ç å®ç°

```python
# åœ¨ label/triple_barrier.py çš„ forming_barriers å‡½æ•°ä¸­ï¼š

profit_taking_multiple = pt_sl[0]  # ä¾‹å¦‚ 2
stop_loss_multiple = pt_sl[1]      # ä¾‹å¦‚ 2

# å…³é”®ï¼šåŠ¨æ€è®¡ç®—é˜ˆå€¼
profit_taking = profit_taking_multiple * events_['trgt']  # trgt æ˜¯ç›®æ ‡æ³¢åŠ¨ç‡
stop_loss = -stop_loss_multiple * events_['trgt']
```

### æ•ˆæœå¯¹æ¯”

| å¸‚åœºçŠ¶æ€ | æ—¥æ³¢åŠ¨ç‡ | å€æ•°è®¾ç½® | å®é™…æ­¢ç›ˆé˜ˆå€¼ | æ•ˆæœ |
|---------|---------|---------|-------------|------|
| **å¹³é™æœŸ** | 0.5% | 2å€ | 2 Ã— 0.5% = **1%** | âœ… é€‚åº”ä½æ³¢åŠ¨ï¼Œå®¹æ˜“è§¦å‘ |
| **æ­£å¸¸æœŸ** | 2% | 2å€ | 2 Ã— 2% = **4%** | âœ… æ­£å¸¸å·¥ä½œ |
| **æš´æ¶¨æœŸ** | 8% | 2å€ | 2 Ã— 8% = **16%** | âœ… é€‚åº”é«˜æ³¢åŠ¨ï¼Œä¸ä¼šè¿‡æ—©é€€å‡º |

---

## ğŸ’¡ å…·ä½“ä¾‹å­

### ä¾‹å­1ï¼šETH ä»·æ ¼æ³¢åŠ¨

```python
# å‡è®¾ ETH ä»·æ ¼æ•°æ®
æ—¶é—´Aï¼šä»·æ ¼ $2000ï¼Œæœ€è¿‘æ³¢åŠ¨ç‡ = 1%ï¼ˆå¹³é™ï¼‰
æ—¶é—´Bï¼šä»·æ ¼ $2000ï¼Œæœ€è¿‘æ³¢åŠ¨ç‡ = 5%ï¼ˆå‰§çƒˆï¼‰

# ä½¿ç”¨ pt_sl=[2, 2]
æ—¶é—´Aï¼š
  æ­¢ç›ˆé˜ˆå€¼ = 2 Ã— 1% = 2%  â†’ ä»·æ ¼æ¶¨åˆ° $2040 å°±æ­¢ç›ˆ
  æ­¢æŸé˜ˆå€¼ = 2 Ã— 1% = 2%  â†’ ä»·æ ¼è·Œåˆ° $1960 å°±æ­¢æŸ

æ—¶é—´Bï¼š
  æ­¢ç›ˆé˜ˆå€¼ = 2 Ã— 5% = 10% â†’ ä»·æ ¼æ¶¨åˆ° $2200 æ‰æ­¢ç›ˆ
  æ­¢æŸé˜ˆå€¼ = 2 Ã— 5% = 10% â†’ ä»·æ ¼è·Œåˆ° $1800 æ‰æ­¢æŸ
```

**ç»“è®ºï¼š** é˜ˆå€¼éšå¸‚åœºæ³¢åŠ¨ç‡è‡ªåŠ¨è°ƒæ•´ï¼

---

## ğŸ“ æ•°å­¦æ¨å¯¼

### æ ‡å‡†åŒ–æ”¶ç›Šç‡

ç›®æ ‡æ³¢åŠ¨ç‡çš„ä½œç”¨ç±»ä¼¼äº**æ ‡å‡†åŒ–**ï¼š

```
æ ‡å‡†åŒ–æ”¶ç›Š = å®é™…æ”¶ç›Š / æ³¢åŠ¨ç‡

å½“ å®é™…æ”¶ç›Š > pt_sl[0] Ã— æ³¢åŠ¨ç‡ æ—¶ï¼Œè§¦å‘æ­¢ç›ˆ
â†“
ç­‰ä»·äºï¼šå®é™…æ”¶ç›Š/æ³¢åŠ¨ç‡ > pt_sl[0]
â†“
å³ï¼šæ ‡å‡†åŒ–æ”¶ç›Š > pt_sl[0]
```

### ç»Ÿè®¡æ„ä¹‰

åœ¨æ­£æ€åˆ†å¸ƒå‡è®¾ä¸‹ï¼š

```
æ³¢åŠ¨ç‡ = æ”¶ç›Šç‡çš„æ ‡å‡†å·®ï¼ˆÏƒï¼‰

pt_sl=[2, 2] æ„å‘³ç€ï¼š
- æ­¢ç›ˆè§¦å‘ï¼šä»·æ ¼æ¶¨äº† 2ä¸ªæ ‡å‡†å·®ï¼ˆçº¦ 95%åˆ†ä½æ•°ï¼‰
- æ­¢æŸè§¦å‘ï¼šä»·æ ¼è·Œäº† 2ä¸ªæ ‡å‡†å·®
```

è¿™æ ·çš„è®¾ç½®åœ¨**ç»Ÿè®¡ä¸Šæ˜¯ä¸€è‡´çš„**ï¼Œæ— è®ºå¸‚åœºæ³¢åŠ¨å¤§å°ã€‚

---

## ğŸ” å¦‚ä½•è®¡ç®—ç›®æ ‡æ³¢åŠ¨ç‡

### æ–¹æ³•1ï¼šæ»šåŠ¨æ ‡å‡†å·®ï¼ˆå¸¸ç”¨ï¼‰

```python
# åœ¨ multi_model_main.py ä¸­
target_volatility = close_series.pct_change().rolling(
    window=rolling_window  # ä¾‹å¦‚ 2000
).std()
```

- **ä¼˜ç‚¹**ï¼šç®€å•ç›´æ¥ï¼Œåæ˜ æœ€è¿‘çš„æ³¢åŠ¨æƒ…å†µ
- **ç¼ºç‚¹**ï¼šå¯¹æç«¯å€¼æ•æ„Ÿ

### æ–¹æ³•2ï¼šæŒ‡æ•°åŠ æƒç§»åŠ¨å¹³å‡ï¼ˆEWMAï¼‰

```python
target_volatility = close_series.pct_change().ewm(
    span=20  # æˆ–å…¶ä»–spanå€¼
).std()
```

- **ä¼˜ç‚¹**ï¼šå¯¹è¿‘æœŸæ•°æ®æƒé‡æ›´é«˜ï¼Œå“åº”æ›´å¿«
- **é€‚ç”¨**ï¼šå¿«é€Ÿå˜åŒ–çš„å¸‚åœº

### æ–¹æ³•3ï¼šGARCHæ¨¡å‹ï¼ˆé«˜çº§ï¼‰

```python
from arch import arch_model
model = arch_model(returns, vol='Garch', p=1, q=1)
result = model.fit()
target_volatility = result.conditional_volatility
```

- **ä¼˜ç‚¹**ï¼šæ›´å‡†ç¡®çš„æ³¢åŠ¨ç‡é¢„æµ‹
- **ç¼ºç‚¹**ï¼šè®¡ç®—å¤æ‚

---

## ğŸ“ å­¦æœ¯æ¥æº

è¿™ä¸ªæ–¹æ³•æ¥è‡ª **Marcos LÃ³pez de Prado** çš„ä¹¦ç±ï¼š
- ã€ŠAdvances in Financial Machine Learningã€‹
- Chapter 3: Labeling - The Triple-Barrier Method

### æ ¸å¿ƒæ€æƒ³

> "The width of the barriers should be a function of the volatility of the underlying, 
> so that they adapt to changing market conditions."

ç¿»è¯‘ï¼š
> "å±éšœçš„å®½åº¦åº”è¯¥æ˜¯æ ‡çš„æ³¢åŠ¨ç‡çš„å‡½æ•°ï¼Œä»¥ä¾¿é€‚åº”å˜åŒ–çš„å¸‚åœºæ¡ä»¶ã€‚"

---

## ğŸš€ å®è·µå»ºè®®

### é€‰æ‹©åˆé€‚çš„æ³¢åŠ¨ç‡çª—å£

| äº¤æ˜“é£æ ¼ | æ¨èçª—å£ | è¯´æ˜ |
|---------|---------|------|
| **æ—¥å†…äº¤æ˜“** | 100-500æ ¹Kçº¿ | å¿«é€Ÿå“åº”çŸ­æœŸæ³¢åŠ¨ |
| **æ³¢æ®µäº¤æ˜“** | 1000-2000æ ¹Kçº¿ | å¹³è¡¡çŸ­æœŸå’Œé•¿æœŸæ³¢åŠ¨ |
| **è¶‹åŠ¿è·Ÿè¸ª** | 2000-5000æ ¹Kçº¿ | å…³æ³¨é•¿æœŸæ³¢åŠ¨è¶‹åŠ¿ |

### è°ƒè¯•æŠ€å·§

```python
# æ£€æŸ¥æ³¢åŠ¨ç‡æ˜¯å¦åˆç†
print(f"æ³¢åŠ¨ç‡ç»Ÿè®¡ï¼š")
print(f"  å‡å€¼: {target_volatility.mean():.4f}")
print(f"  æ ‡å‡†å·®: {target_volatility.std():.4f}")
print(f"  æœ€å°å€¼: {target_volatility.min():.4f}")
print(f"  æœ€å¤§å€¼: {target_volatility.max():.4f}")

# ç»˜åˆ¶æ³¢åŠ¨ç‡å˜åŒ–
import matplotlib.pyplot as plt
plt.plot(target_volatility)
plt.title('ç›®æ ‡æ³¢åŠ¨ç‡éšæ—¶é—´å˜åŒ–')
plt.show()
```

---

## ğŸ“Š å¯¹æ¯”æ€»ç»“

| ç‰¹æ€§ | å›ºå®šé˜ˆå€¼ | åŠ¨æ€é˜ˆå€¼ï¼ˆä½¿ç”¨æ³¢åŠ¨ç‡ï¼‰ |
|------|---------|----------------------|
| **é€‚åº”æ€§** | âŒ ä¸é€‚åº”å¸‚åœºå˜åŒ– | âœ… è‡ªåŠ¨é€‚åº” |
| **ç¨³å®šæ€§** | âŒ ä¸åŒæ—¶æœŸè¡¨ç°å·®å¼‚å¤§ | âœ… ç»Ÿè®¡ä¸Šä¸€è‡´ |
| **å‚æ•°è®¾ç½®** | âŒ éœ€è¦é¢‘ç¹è°ƒæ•´ | âœ… ä¸€æ¬¡è®¾ç½®é•¿æœŸæœ‰æ•ˆ |
| **è®¡ç®—å¤æ‚åº¦** | âœ… ç®€å• | âš ï¸ éœ€è¦è®¡ç®—æ³¢åŠ¨ç‡ |
| **æ¨èä½¿ç”¨** | âŒ ä¸æ¨è | âœ… **å¼ºçƒˆæ¨è** |

---

## ğŸ’» å®Œæ•´ä»£ç ç¤ºä¾‹

```python
import pandas as pd
import numpy as np
from label.triple_barrier import get_barrier

# å‡†å¤‡æ•°æ®
close_series = pd.Series(price_data, index=time_index)

# è®¡ç®—ç›®æ ‡æ³¢åŠ¨ç‡ï¼ˆæ»šåŠ¨æ ‡å‡†å·®ï¼‰
target_volatility = close_series.pct_change().rolling(
    window=500,
    min_periods=100
).std()

# å¡«å……åˆå§‹çš„ NaN å€¼
target_volatility = target_volatility.fillna(method='bfill')

# ä½¿ç”¨ Triple Barrierï¼ˆåŠ¨æ€é˜ˆå€¼ï¼‰
barrier_results = get_barrier(
    close=close_series,
    enter=close_series.index,
    pt_sl=[2, 2],              # æ­¢ç›ˆæ­¢æŸå„2å€æ³¢åŠ¨ç‡
    max_holding=[0, 4],        # æœ€å¤šæŒæœ‰4å°æ—¶
    target=target_volatility,  # â­ å…³é”®ï¼šä¼ å…¥ç›®æ ‡æ³¢åŠ¨ç‡
    side=None
)

# æŸ¥çœ‹ç»“æœ
print(f"å¹³å‡æ­¢ç›ˆé˜ˆå€¼: {(2 * target_volatility).mean():.4f}")
print(f"å¹³å‡æ­¢æŸé˜ˆå€¼: {(2 * target_volatility).mean():.4f}")
print(f"é˜ˆå€¼å˜åŒ–èŒƒå›´: [{(2 * target_volatility).min():.4f}, {(2 * target_volatility).max():.4f}]")
```

---

## ğŸ¯ å…³é”®è¦ç‚¹

1. **ç›®æ ‡æ³¢åŠ¨ç‡**ä½¿æ­¢ç›ˆæ­¢æŸé˜ˆå€¼**è‡ªé€‚åº”å¸‚åœºæ³¢åŠ¨**
2. `pt_sl` æ˜¯**å€æ•°**ï¼Œå®é™…é˜ˆå€¼ = `pt_sl Ã— æ³¢åŠ¨ç‡`
3. è¿™æ ·è®¾ç½®åœ¨**ç»Ÿè®¡ä¸Šæ˜¯ä¸€è‡´çš„**ï¼Œä¸åŒæ—¶æœŸè¡¨ç°ç¨³å®š
4. æ¥è‡ªå­¦æœ¯ç•Œæœ€ä½³å®è·µï¼ˆLÃ³pez de Pradoï¼‰
5. æ˜¯ Triple Barrier æ–¹æ³•çš„**æ ¸å¿ƒä¼˜åŠ¿**ä¹‹ä¸€

---

**ç»“è®ºï¼š** ç›®æ ‡æ³¢åŠ¨ç‡ä¸æ˜¯å¯é€‰çš„ï¼Œè€Œæ˜¯ Triple Barrier æ–¹æ³•èƒ½å¤Ÿ**é€‚åº”å¸‚åœºå˜åŒ–**çš„å…³é”®æœºåˆ¶ï¼

